#!/usr/bin/env php
<?php

use App\Kernel;
use Symfony\Component\HttpFoundation\Request;

set_time_limit(0);

require dirname(__DIR__) . '/config/bootstrap.php';

$f = function () {
    $kernel = new Kernel('prod', false);
    $kernel->boot();
    $request = Request::create('/leak');

    $response = $kernel->handle($request);

    $kernel->terminate($request, $response);
    $kernel->shutdown();
};

foreach (range(1, 1000) as $i) {

    $f();

    gc_collect_cycles();
    if (!($i % 10)) {
        echo round(memory_get_usage() / 1024 / 1024, 6) . PHP_EOL;
    }
}
unset($f);

